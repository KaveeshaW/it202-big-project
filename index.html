<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
<!--     <link rel="manifest" href="manifest.json" /> -->
    <title>Big Project</title>
  <link href="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.js"></script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
  <link rel="manifest" href="./site.webmanifest">

  <style>
    :root {
      --mdc-theme-primary: navy;
    }

    body {margin: 0;}
    main {margin-left: 8px;}

    .view {
      display: none;
    }
  </style>

  </head>
  <body>  
    <!--we will put the cards in the container-->
    <div class="container"></div>
    <aside class="mdc-drawer mdc-drawer--modal">
    <div class="mdc-drawer__content">
      <nav class="mdc-list">
        <a class="mdc-list-item mdc-list-item--activated" href="#home" aria-current="page">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">home</i>
          <span class="mdc-list-item__text">Home</span>
        </a>
        <a class="mdc-list-item" href="#search" aria-current="page">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">search</i>
          <span class="mdc-list-item__text">Search</span>
        </a>
        <a class="mdc-list-item" href="#table">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">table_chart</i>
          <span class="mdc-list-item__text">Table</span>
        </a>
        <a class="mdc-list-item" href="#chart">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">show_chart</i>
          <span class="mdc-list-item__text">Chart</span>
        </a>
        <a class="mdc-list-item" href="#history">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">history</i>
          <span class="mdc-list-item__text">History</span>
        </a>
      </nav>
    </div>
  </aside>

  <div class="mdc-drawer-scrim"></div>

<header class="mdc-top-app-bar">
  <div class="mdc-top-app-bar__row">
    <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
      <button class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button">menu</button>
      <span class="mdc-top-app-bar__title">Big Project</span>
    </section>
    <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
      <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Download">file_download</button>
      <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Print this page">print</button>
      <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Bookmark this page">bookmark</button>
    </section>
  </div>
</header>

  <main class="mdc-top-app-bar--fixed-adjust">
    <div class="view" id="home">Home
      <p>This is the big project. The data comes from https://pomber.github.io/covid19/timeseries.json</p></div>
    
    <div class="view" id="search">Search
    <input list="countryList" name="country" id="theCountryList">
      <datalist id="countryList">
      </datalist>
    <button type="submit" id="submitCountry">Add Country</button>
    <button id="plotThings">Plot</button>
    <p id="listOfCountries"></p>
    </div>
    
    <div class="view" id="table">Table Of Confirmed Cases <div id="table_div"></div>
    </div>
    
    <div class="view" id="chart">Chart
    <div id="curve_chart" style="width: 900px; height: 500px"></div></div>
    
    <div class="view" id="history">This is the history of the countries you have plotted so far (not added)
    <p id="historyDisplay"></p>
    </div>

  </main>

  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script src="js/app.js"></script>
    
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function() {
        navigator.serviceWorker
          .register("/serviceWorker.js")
          .then(res => console.log("service worker registered"))
          .catch(err => console.log("service worker not registered", err))
      })
    } 

    //load google charts package
      google.charts.load('current', {'packages':['corechart', 'table']});
      let totalRecovered = 0;
      let countryNames = [];
      let specificData = {};
      let userPlotted = false;
      let stateNames = [];
      
      //-------------------------------------------------------------
      //dexie database
      const db = new Dexie('BigProject');

      db.version(1).stores({
        previousCountries: '++id, country, date'
      });
      //-------------------------------------------------------------
      
//       db.previousCountries.add({
//         title: "US",
//         date: new Date()
//       });
      
      getData = () => {
        //first api
        fetch("https://covidtracking.com/api/v1/states/current.json")
        .then(response => response.json()) 
        .then(data => {
          for(const state of data) {
            console.log(state);
            stateNames.push(state.state);
          }
          console.log(stateNames);
        });
        
        //second api
        fetch("https://pomber.github.io/covid19/timeseries.json")
      .then(response => response.json())
      .then(data => {
        specificData = data;
        let dataList = document.querySelector("#countryList"); 
        for(const country in data) {
           //gets the names of every country
           countryNames.push(country);
          
          //for the option menu showing all of the different countries
           let option = document.createElement("option");
           option.textContent = country;
           option.value = country;
           dataList.appendChild(option);
        }
      });
      }
      
      //adds the country to a list that will be used to display later
      let whichCountry = document.querySelector("#theCountryList");
      let userSelection = [];
      document.querySelector("#submitCountry")
        .addEventListener("click", (event) =>
        {
        //clears everything
        if(userPlotted) {
          userSelection = [];
          realData = [];
          specificRow = [];
          chart.clearChart();
          table.clearChart();
          //document.querySelector("p#historyDisplay").textContent = "";
        }
        userSelection.push(whichCountry.value);
        let paragraph = document.querySelector("#listOfCountries");
        if(userPlotted) {
          paragraph.textContent = "";
          userPlotted = false;
        }
        paragraph.textContent += whichCountry.value + " ";
        
        //the value where the user choses the country is set to blank
        whichCountry.value = "";
        });
      
      //let totalDataPoints = 0;
      let maxDataPoints = 0;
      let dataArray = [["date", "confirmed", "country"]];
      console.log(specificData["US"]);
      let realData = [];
      let count = 0;
      let specificRow = [];
      let alreadyPushed = false;
      let date = "";
      let plotNumber = 1;
      document.querySelector("#plotThings")
        .addEventListener("click", (event) =>                        
        {
          userPlotted = true;
          //populates the first row with the date and the country
          specificRow.push("Date");
        
          let eachPlotParagraph = document.createElement("p");
           eachPlotParagraph.textContent = "This is plot number: " + plotNumber;
           document.querySelector("p#historyDisplay").appendChild(eachPlotParagraph);
           plotNumber++;
        
          for(const myCountry of userSelection) {
            specificRow.push(myCountry);
            //adds it to the database
            db.previousCountries.add({
              country: myCountry,
              date: new Date()
            });
            
           db.previousCountries.toCollection().last()
          .then( (choice) => {
              let p = document.createElement("p");
              p.textContent = choice.country + " " + choice.date;
              document.querySelector("p#historyDisplay").appendChild(p);
           });
          }
//           let p = document.createElement("p");
//           p.textContent = a.country + " " + a.date;
//           document.querySelector("p#historyDisplay").appendChild(p);
          
//           db.previousCountries.toArray()
//           .then((arr) => {
//             for(let a of arr){
//               let p = document.createElement("p");
//               p.textContent = a.country + " " + a.date;
//               document.querySelector("p#historyDisplay").appendChild(p);
//             }
//           }); 
          realData.push(specificRow);
        
          //checking the data that is in the json, I looked at china and it started at 1-22-2020
          //and the US started on that date too. From that point I figured that all of the dates start at the same point
          //so I kind of hard coded it to just the US, but it will change based on the number of days in the data
          for(let index = 0; index < specificData["US"].length; index++) {
            //this is done so that there isn't one big row but multiple small rows for each day
            specificRow = [];
            for(const country of userSelection) {
                //I only want to push the date once per row
                if(alreadyPushed === false) {
                  date = specificData[country][index].date;
                  specificRow.push(date);
                  alreadyPushed = true;
                }
                let numConfirmed = specificData[country][index].confirmed;
                specificRow.push(numConfirmed);
            }
            //pushes the row into the table of data I will use to plot the graph and the table
            realData.push(specificRow);
            alreadyPushed = false;
          }
          console.log(realData);
          let paragraph = document.querySelector("#listOfCountries");
          paragraph.textContent += "When you add countries after plotting, the table and chart will reset.";
          document.querySelector("#search").style.display = "none";
          document.querySelector("#table").style.display = "block";
          
          //shows the right tab in the hamburger
//           document.querySelector("[href='#search']").classList.remove("mdc-list-item--activated");
//           document.querySelector("[href='#table']").classList.add("mdc-list-item--activated");
          drawChart(realData);
          drawTable(realData);
      });
      
      //-------------------------------------------------------------
      //creates the line chart
      let chart;
      drawChart = (dataArray) => {
        
        //convert into a google charts table
        //the first row needs to be what each column represents, otherwise the array would not work
        let data = new google.visualization.arrayToDataTable(dataArray);
        let options = {
          title: 'COVID-19 Confirmed Cases',
          curveType: 'function',
          legend: { position: 'bottom' }
        };
        chart = new google.visualization.LineChart(document.querySelector('#curve_chart'));
        chart.draw(data, options);
      }
      //-------------------------------------------------------------
      
      //-------------------------------------------------------------
      //creates the table 
      let table;
      drawTable = (dataArray) => {
        let data = new google.visualization.arrayToDataTable(dataArray);
        table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(data, {width: '50%', height: '50%'});
      }
      //-------------------------------------------------------------
         
    google.charts.setOnLoadCallback(getData);

    //-------------------------------------------------------------
    //dexie database
//     const db = new Dexie('BigProject');

//     db.version(1).stores({
//       favorites: '++id, country, date'
//     });

//     db.favorites.add({
//       title: "Once Upon a Time in Hollywood",
//       rating: 4,
//       year: 2019,
//       date: new Date()
//     });

//     db.favorites.add({
//       title: "Pad Thai Hero",
//       rating: 5,
//       year: 2019
//     });

//     db.favorites.add({
//       title: "Quantum",
//       rating: 5,
//       year: 2019
//     });

      //db.favorites.where("title").startsWith("O").delete();

//   db.favorites.toArray()
//   .then((arr) => {
//     for(let a of arr){
//       let p = document.createElement("p");
//       p.textContent = a.title;
//       document.body.appendChild(p);
//     }
//   }); 
      //-------------------------------------------------------------
   
    //-------------------------------------------------------------
    //this has to do with the app shell logic itself
    //mdc.ripple.MDCRipple.attachTo(document.querySelector('.foo-button'));
    mdc.topAppBar.MDCTopAppBar.attachTo(document.querySelector('header.mdc-top-app-bar'));

    const drawer = mdc.drawer.MDCDrawer.attachTo(document.querySelector('.mdc-drawer'));
//     document.querySelector("div#curve_chart").style.display = "none";

    const hideViews = () => {
      document.querySelectorAll("div.view").forEach(item => {
        item.style.display = "none";
      })  
    };

    document.querySelector(".mdc-top-app-bar__navigation-icon")
      .addEventListener("click", 
          (e) => {drawer.open = true;}
      );

    document.querySelectorAll("aside.mdc-drawer a.mdc-list-item").forEach(item => {
      item.addEventListener('click', event => {
        hideViews();
        //could also use event.toElement.id if the specific tag has an id
        //target is an id selector with the hash symbol
        let target = item.getAttribute("href");
        document.querySelector(target).style.display = "block";
        drawer.open = false;
      })
    })
      
    document.querySelector("div#home").style.display = "block";
    //-------------------------------------------------------------
    </script>

  </body>
</html> 