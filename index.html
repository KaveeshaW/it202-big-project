<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
<!--     <link rel="manifest" href="manifest.json" /> -->
    <title>Big Project</title>
  <link href="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@v4.0.0/dist/material-components-web.min.js"></script>

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
  <link rel="manifest" href="./site.webmanifest">

  <style>
    :root {
      --mdc-theme-primary: navy;
    }

    body {margin: 0;}
    main {margin-left: 8px;}

    .view {
      display: none;
    }
    
    .template {
      display: none;
    }
  </style>

  </head>
  <body>  
    <!--we will put the cards in the container-->
    <div class="container"></div>
    <aside class="mdc-drawer mdc-drawer--modal">
    <div class="mdc-drawer__content">
      <nav class="mdc-list">
        <a class="mdc-list-item mdc-list-item--activated" href="#home" aria-current="page">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">home</i>
          <span class="mdc-list-item__text">Home</span>
        </a>
        <a class="mdc-list-item" href="#search" aria-current="page">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">search</i>
          <span class="mdc-list-item__text">Search</span>
        </a>
        <a class="mdc-list-item" href="#table">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">table_chart</i>
          <span class="mdc-list-item__text">Table</span>
        </a>
        <a class="mdc-list-item" href="#chart">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">show_chart</i>
          <span class="mdc-list-item__text">Line Chart</span>
        </a>
        <a class="mdc-list-item" href="#history">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">history</i>
          <span class="mdc-list-item__text">History</span>
        </a>
        <a class="mdc-list-item" href="#weather">
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">wb_sunny</i>
          <span class="mdc-list-item__text">Weather</span>
        </a>
      </nav>
    </div>
  </aside>

  <div class="mdc-drawer-scrim"></div>

<header class="mdc-top-app-bar">
  <div class="mdc-top-app-bar__row">
    <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
      <button class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button">menu</button>
      <span class="mdc-top-app-bar__title">Big Project</span>
    </section>
  </div>
</header>

  <main class="mdc-top-app-bar--fixed-adjust">
    <div class="view" id="home"><h1>Home</h1>
      <p>This is the big project. <br> The data comes from https://pomber.github.io/covid19/timeseries.json 
      and https://api.openweathermap.org/data/2.5/weather (with the use of an api key)</p></div>
    
    <div class="view" id="search"> <h1>Search</h1> <br>
    <input list="countryList" name="country" id="theCountryList">
      <datalist id="countryList">
      </datalist>
<!--     <button type="submit" id="submitCountry">Add Country</button>
    <button id="plotThings">Plot</button> -->
    <button id="submitCountry" type="submit" class="mdc-button foo-button mdc-button--raised">
      <div class="mdc-button__ripple"></div>
      <span class="mdc-button__label">Add Country</span>
    </button>
    <button id="plotThings" class="mdc-button foo-button mdc-button--raised">
      <div class="mdc-button__ripple"></div>
      <span class="mdc-button__label">Plot</span>
    </button>
    <p id="listOfCountries"></p>
    </div>
    
    <div class="view" id="table"><h1>Table Of Confirmed Cases</h1> <div id="table_div"></div>
    </div>
    
    <div class="view" id="chart"><h1>Line Chart</h1>
    <div id="curve_chart" style="width: 900px; height: 500px"></div></div>
    
    <div class="view" id="history">
      <h1>History</h1>
      This is the history of the countries you have plotted (not added to the list) so far 
    <p id="historyDisplay"></p>
    </div>
    
    <div class="view" id="weather"><h1>Weather</h1>
    <br>This page shows the weather at your current location if you allow it, otherwise it will not display anything
    <br><br>
    <button id="getLocation" class="mdc-button foo-button mdc-button--raised">
      <div class="mdc-button__ripple"></div>
      <span class="mdc-button__label">Enable Location</span>
    </button>
    <p id="weatherInfo"></p>
      
    <!-- Card that will be used to display the weather -->
    <div class="mdc-card template demo-card">
      <div class="mdc-card__primary-action demo-card__primary-action" tabindex="0">
<!--         <div class="mdc-card__media mdc-card__media--16-9 demo-card__media" style="background-image: url(&quotutton;https://material-components.github.io/material-components-web-catalog/static/media/photos/3x2/2.jpg&quot;);"></div> -->
        <div class="demo-card__primary">
          <h2 class="demo-card__title mdc-typography mdc-typography--headline6">Our Changing Planet</h2>
          <h3 class="demo-card__subtitle mdc-typography mdc-typography--subtitle2">by Kurt Wagner</h3>
        </div>
        <div class="demo-card__secondary mdc-typography mdc-typography--body2">Visit ten places on our planet that are undergoing the biggest changes today.</div>
      </div>
<!--       <div class="mdc-card__actions">
        <div class="mdc-card__action-buttons">
          <button class="mdc-button mdc-card__action mdc-card__action--button">  <span class="mdc-button__ripple"></span> Read</button>
          <button class="mdc-button mdc-card__action mdc-card__action--button">  <span class="mdc-button__ripple"></span> Bookmark</button>
        </div>
        <div class="mdc-card__action-icons">
          <button class="mdc-icon-button mdc-card__action mdc-card__action--icon--unbounded" aria-pressed="false" aria-label="Add to favorites" title="Add to favorites">
            <i class="material-icons mdc-icon-button__icon mdc-icon-button__icon--on">favorite</i>
            <i class="material-icons mdc-icon-button__icon">favorite_border</i>
          </button>
          <button class="mdc-icon-button material-icons mdc-card__action mdc-card__action--icon--unbounded" title="Share" data-mdc-ripple-is-unbounded="true">share</button>
          <button class="mdc-icon-button material-icons mdc-card__action mdc-card__action--icon--unbounded" title="More options" data-mdc-ripple-is-unbounded="true" id="human">accessibility</button>
        </div>
      </div> -->
    </div> 
    <!-- Card that will be used to display the weather -->
    
    </div>


  </main>

  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script src="js/app.js"></script>
    
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
    if ('serviceWorker' in navigator) {
        //wait for load
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./serviceWorker.js').then((registration) => {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, (err) => {
            // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

    //load google charts package
      google.charts.load('current', {'packages':['corechart', 'table']});
      let totalRecovered = 0;
      let countryNames = [];
      let specificData = {};
      let userPlotted = false;
      let stateNames = [];
      
      //-------------------------------------------------------------
      //dexie database
      const db = new Dexie('BigProject');

      db.version(1).stores({
        previousCountries: '++id, country, date'
      });
      //-------------------------------------------------------------
      
//       db.previousCountries.add({
//         title: "US",
//         date: new Date()
//       });
      
      getData = () => {
        //second api
        fetch("https://pomber.github.io/covid19/timeseries.json")
      .then(response => response.json())
      .then(data => {
        specificData = data;
        let dataList = document.querySelector("#countryList"); 
        for(const country in data) {
           //gets the names of every country
           countryNames.push(country);
          
          //for the option menu showing all of the different countries
           let option = document.createElement("option");
           option.textContent = country;
           option.value = country;
           dataList.appendChild(option);
        }
      });
      }
      
      //adds the country to a list that will be used to display later
      let whichCountry = document.querySelector("#theCountryList");
      let userSelection = [];
      document.querySelector("#submitCountry")
        .addEventListener("click", (event) =>
        {
        //clears everything
        if(userPlotted) {
          userSelection = [];
          realData = [];
          specificRow = [];
          chart.clearChart();
          table.clearChart();
          //document.querySelector("p#historyDisplay").textContent = "";
        }
        userSelection.push(whichCountry.value);
        let paragraph = document.querySelector("#listOfCountries");
        if(userPlotted) {
          paragraph.textContent = "";
          userPlotted = false;
        }
        paragraph.textContent += whichCountry.value + " ";
        
        //the value where the user choses the country is set to blank
        whichCountry.value = "";
        });
      
      //let totalDataPoints = 0;
      let maxDataPoints = 0;
      let dataArray = [["date", "confirmed", "country"]];
      //console.log(specificData["US"]);
      let realData = [];
      let count = 0;
      let specificRow = [];
      let alreadyPushed = false;
      let date = "";
      let plotNumber = 1;
      document.querySelector("#plotThings")
        .addEventListener("click", (event) =>                        
        {
          userPlotted = true;
          //populates the first row with the date and the country
          specificRow.push("Date");
          
          //plots the user data in the history page
          let eachPlotParagraph = document.createElement("p");
           eachPlotParagraph.textContent = "This is plot number: " + plotNumber;
           document.querySelector("p#historyDisplay").appendChild(eachPlotParagraph);
           plotNumber++;
        
          for(const myCountry of userSelection) {
            specificRow.push(myCountry);
            //adds it to the database
            db.previousCountries.add({
              country: myCountry,
              date: new Date()
            });
           //while in the loop, each country chosen to be plotted will be plotted
           db.previousCountries.toCollection().last()
          .then( (choice) => {
              let p = document.createElement("p");
              p.textContent = choice.country + " " + choice.date;
              document.querySelector("p#historyDisplay").appendChild(p);
           });
          }
//           let p = document.createElement("p");
//           p.textContent = a.country + " " + a.date;
//           document.querySelector("p#historyDisplay").appendChild(p);
          
//           db.previousCountries.toArray()
//           .then((arr) => {
//             for(let a of arr){
//               let p = document.createElement("p");
//               p.textContent = a.country + " " + a.date;
//               document.querySelector("p#historyDisplay").appendChild(p);
//             }
//           }); 
          realData.push(specificRow);
        
          //checking the data that is in the json, I looked at china and it started at 1-22-2020
          //and the US started on that date too. From that point I figured that all of the dates start at the same point
          //so I kind of hard coded it to just the US, but it will change based on the number of days in the data
          for(let index = 0; index < specificData["US"].length; index++) {
            //this is done so that there isn't one big row but multiple small rows for each day
            specificRow = [];
            for(const country of userSelection) {
                //I only want to push the date once per row
                if(alreadyPushed === false) {
                  date = specificData[country][index].date;
                  specificRow.push(date);
                  alreadyPushed = true;
                }
                let numConfirmed = specificData[country][index].confirmed;
                specificRow.push(numConfirmed);
            }
            //pushes the row into the table of data I will use to plot the graph and the table
            realData.push(specificRow);
            alreadyPushed = false;
          }
          //console.log(realData);
          let paragraph = document.querySelector("#listOfCountries");
          paragraph.textContent += "When you add countries after plotting, the table and chart will reset.";
          document.querySelector("#search").style.display = "none";
          document.querySelector("#table").style.display = "block";
          
          //shows the right tab in the hamburger
//           document.querySelector("[href='#search']").classList.remove("mdc-list-item--activated");
//           document.querySelector("[href='#table']").classList.add("mdc-list-item--activated");

          drawChart(realData);
          drawTable(realData);
//           if(navigator.onLine === true) {
//             console.log("here!!!");
//             document.querySelector("div#table").textContent = "Table of Confirmed Cases";
//             document.querySelector("div#chart").textContent = "Chart";
//             drawChart(realData);
//             drawTable(realData);
//           }
//           else {
//             document.querySelector("div#table").textContent = "cannot access data offline";
//             document.querySelector("div#chart").textContent = "cannot access data offline";
//           }
      });
      
      const weatherInfo = document.querySelector("p#weatherInfo");
      //handles logic with the weather screen
      document.querySelector("button#getLocation").addEventListener("click", (event) => {
         
         //does the browser support geolocation?
         if (!navigator.geolocation) {
            weatherInfo.textContent = 'Geolocation is not supported by your browser';
          } else {
            weatherInfo.textContent = 'Locatingâ€¦';
            //there are two different callback functions, one is by default, the other one is optional where I want to handle the error
            navigator.geolocation.getCurrentPosition(success, error) ;
          }
//         navigator.geolocation.getCurrentPosition((position) => {
//           let lat = position.coords.latitude;
//           let lng = position.coords.longitude;
//           console.log(lat);
//           console.log(lng);
//         });
      });
      
      //the getCurrentPosition function gives back access to the location data
      success = (position) => {
        let lat = position.coords.latitude;
        let lng = position.coords.longitude;
        
        //has my key and the right units, longitude and latitude
        let weatherApi = "https://api.openweathermap.org/data/2.5/weather?appid=f4969555fb49e9a8e0c6d4f181a2a3e0&units=imperial" + "&lat=" + lat + "&lon=" + lng;;
        //returns street view
//         let streetView = "https://maps.googleapis.com/maps/api/streetview?size=456x456&key=AIzaSyAujKzyHSByW_g3z-CRvoxFEFIBjhe9YPg&location=" + lat + "," + lng;
//         const urls = [
//           weatherApi,
//           streetView
//         ]
//         //maps all of the fetches into an array
//         const allRequests = urls.map( (url) => {
//           fetch(url).then( (response) => {
//                           response.json()
//           })
//         });
        
//         //need to access the data
//         Promise.all(allRequests).then((arrayOfResponses) => {
//           console.log("The data from the server:", arrayOfResponses);
//         })
        
        fetch(weatherApi)
        .then(response => response.json())
        .then(data => {
          weatherInfo.textContent = 'Success';
          console.log(data);
          let clone = document.querySelector("div.template").cloneNode(true);
          clone.classList.remove("template");
          clone.querySelector("h2").textContent = "Local Weather Report For " + data.name;
          clone.querySelector("h3").textContent = "The temperature currently in " + data.name + " is " + data.main.temp + " degrees fahrenheit, but it feels like " + data.main.feels_like + " degrees fahrenheit.";
          clone.querySelector(".mdc-typography--body2").textContent = "Wind speeds are at " + data.wind.speed + " miles per hour " + "and cloudiness is at " + data.clouds.all + "%"
          document.querySelector("div#weather").appendChild(clone);
        })
        
        
        //weatherInfo.textContent = 'Success!!';
      }
      
      error = (err) => {
        weatherInfo.textContent = "unable to retrieve your location because either you blocked access or you exited the dialog box";
        //console.warn(`ERROR(${err.code}): ${err.message}`);
//         //         let myBr = document.c
//         weatherInfo.appendChild(document.createElement("br"));
//         weatherInfo.textContent += "Error code: " + error.code + " error message: " + error.message; 
      }
      
      //-------------------------------------------------------------
      //creates the line chart
      let chart;
      drawChart = (dataArray) => {
        
        //convert into a google charts table
        //the first row needs to be what each column represents, otherwise the array would not work
        let data = new google.visualization.arrayToDataTable(dataArray);
        let options = {
          title: 'COVID-19 Confirmed Cases',
          curveType: 'function',
          legend: { position: 'bottom' }
        };
        chart = new google.visualization.LineChart(document.querySelector('#curve_chart'));
        chart.draw(data, options);
      }
      //-------------------------------------------------------------
      
      //-------------------------------------------------------------
      //creates the table 
      let table;
      drawTable = (dataArray) => {
        let data = new google.visualization.arrayToDataTable(dataArray);
        table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(data, {width: '50%', height: '50%'});
      }
      //-------------------------------------------------------------
         
    google.charts.setOnLoadCallback(getData);

    //-------------------------------------------------------------
    //dexie database
//     const db = new Dexie('BigProject');

//     db.version(1).stores({
//       favorites: '++id, country, date'
//     });

//     db.favorites.add({
//       title: "Once Upon a Time in Hollywood",
//       rating: 4,
//       year: 2019,
//       date: new Date()
//     });

//     db.favorites.add({
//       title: "Pad Thai Hero",
//       rating: 5,
//       year: 2019
//     });

//     db.favorites.add({
//       title: "Quantum",
//       rating: 5,
//       year: 2019
//     });

      //db.favorites.where("title").startsWith("O").delete();

//   db.favorites.toArray()
//   .then((arr) => {
//     for(let a of arr){
//       let p = document.createElement("p");
//       p.textContent = a.title;
//       document.body.appendChild(p);
//     }
//   }); 
      //-------------------------------------------------------------
   
    //-------------------------------------------------------------
    //this has to do with the app shell logic itself
    //mdc.ripple.MDCRipple.attachTo(document.querySelector('.foo-button'));
    mdc.topAppBar.MDCTopAppBar.attachTo(document.querySelector('header.mdc-top-app-bar'));

    const drawer = mdc.drawer.MDCDrawer.attachTo(document.querySelector('.mdc-drawer'));
//     document.querySelector("div#curve_chart").style.display = "none";

    const hideViews = () => {
      document.querySelectorAll("div.view").forEach(item => {
        item.style.display = "none";
      })  
    };

    document.querySelector(".mdc-top-app-bar__navigation-icon")
      .addEventListener("click", 
          (e) => {drawer.open = true;}
      );

    document.querySelectorAll("aside.mdc-drawer a.mdc-list-item").forEach(item => {
      item.addEventListener('click', event => {
        hideViews();
        //could also use event.toElement.id if the specific tag has an id
        //target is an id selector with the hash symbol
        let target = item.getAttribute("href");
        document.querySelector(target).style.display = "block";
        drawer.open = false;
      })
    })
      
    document.querySelector("div#home").style.display = "block";
    //-------------------------------------------------------------
    </script>

  </body>
</html> 